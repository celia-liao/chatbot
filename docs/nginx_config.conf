# ============================================
# Nginx 反向代理設定範例
# ============================================
# 檔案位置：/home/ruru1211-chatbot/htdocs/chatbot.ruru1211.xyz/nginx/line-bot.conf
# 或透過 CloudPanel 控制台設定
# ============================================

# 關閉 PageSpeed 模組（避免影響 Webhook）
pagespeed off;

# LINE Bot 主要路由
location /line {
    # 關閉所有快取
    add_header Cache-Control "no-cache, no-store, must-revalidate";
    add_header Pragma "no-cache";
    add_header Expires "0";
    
    # 反向代理到本地 Flask 應用
    proxy_pass http://127.0.0.1:8090;
    
    # 保留原始請求資訊
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    
    # LINE Webhook 需要的 header（重要！）
    proxy_set_header X-Line-Signature $http_x_line_signature;
    
    # 增加超時時間（AI 回應可能需要較長時間）
    proxy_connect_timeout 120s;
    proxy_send_timeout 120s;
    proxy_read_timeout 120s;
    
    # 不緩衝響應
    proxy_buffering off;
    
    # 日誌
    access_log /home/ruru1211-chatbot/logs/nginx-access.log;
    error_log /home/ruru1211-chatbot/logs/nginx-error.log;
}

# Webhook 專用端點（LINE 會呼叫）
location = /line/webhook {
    # 關閉快取
    add_header Cache-Control "no-cache, no-store, must-revalidate";
    
    # 反向代理（移除 /line 前綴）
    rewrite ^/line/webhook$ /webhook break;
    proxy_pass http://127.0.0.1:8090;
    
    # Header 設定
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_set_header X-Line-Signature $http_x_line_signature;
    
    # 超時設定
    proxy_connect_timeout 120s;
    proxy_send_timeout 120s;
    proxy_read_timeout 120s;
    
    # 不緩衝
    proxy_buffering off;
    
    # 只允許 POST 請求和 LINE 的 IP（可選）
    limit_except POST GET {
        deny all;
    }
}

# Health Check 端點
location = /line/healthz {
    rewrite ^/line/healthz$ /healthz break;
    proxy_pass http://127.0.0.1:8090;
    proxy_set_header Host $host;
    access_log off;
}

# 測試端點（可選，生產環境可以移除）
location = /line/test {
    rewrite ^/line/test$ /test break;
    proxy_pass http://127.0.0.1:8090;
    proxy_set_header Host $host;
}

# ============================================
# 設定說明
# ============================================
# 1. proxy_pass: 指向本地 Flask 應用（127.0.0.1:8090）
# 2. proxy_set_header X-Line-Signature: 必須保留此 header 供 LINE SDK 驗證簽名
# 3. proxy_buffering off: 避免緩衝，即時傳遞響應
# 4. proxy_*_timeout: 設定較長的超時時間，因為 AI 回應需要時間
# 5. limit_except: 限制只允許 POST/GET 請求（安全性考量）
#
# ============================================
# 測試方式
# ============================================
# 1. 測試設定檔語法：sudo nginx -t
# 2. 重載 Nginx：sudo systemctl reload nginx
# 3. 測試健康檢查：curl https://chatbot.ruru1211.xyz/line/healthz
# 4. 查看 Nginx 日誌：tail -f /home/ruru1211-chatbot/logs/nginx-error.log
#
# ============================================
# LINE Developers Console Webhook 設定
# ============================================
# Webhook URL: https://chatbot.ruru1211.xyz/line/webhook
#

