# 完整部署流程（chatbot 子資料夾版本）

## 📂 目錄結構

```
/home/ruru1211-chatbot/htdocs/
└── chatbot.ruru1211.xyz/          ← CloudPanel Root Directory
    └── chatbot/                    ← Git repository (專案實際位置)
        ├── mybot/                  ← Flask 應用
        │   ├── __init__.py
        │   ├── app.py
        │   ├── chatbot_ollama.py
        │   ├── config.py
        │   ├── db_utils.py
        │   ├── personalities.py
        │   └── requirements.txt
        ├── scripts/                ← 部署腳本
        │   ├── start_gunicorn.sh
        │   ├── setup_systemd.sh
        │   └── deploy_to_server.sh
        ├── docs/                   ← 文檔與配置範例
        │   ├── env_template.txt
        │   └── nginx_config.conf
        ├── venv/                   ← Python 虛擬環境
        ├── .env                    ← 環境變數（需建立）
        └── .git/                   ← Git repository
```

---

## 🚀 完整部署步驟

### 步驟 1：Git Clone 專案

```bash
# SSH 到伺服器
ssh ruru1211-chatbot@chatbot.ruru1211.xyz

# 進入 CloudPanel Root Directory
cd /home/ruru1211-chatbot/htdocs/chatbot.ruru1211.xyz

# Clone repository（假設你的 GitHub 用戶名是 your-username）
git clone https://github.com/your-username/chatbot.git

# 進入專案目錄
cd chatbot

# 確認路徑
pwd
# 應該顯示：/home/ruru1211-chatbot/htdocs/chatbot.ruru1211.xyz/chatbot
```

---

### 步驟 2：建立虛擬環境並安裝依賴

```bash
# 確認在 chatbot 目錄
cd /home/ruru1211-chatbot/htdocs/chatbot.ruru1211.xyz/chatbot

# 建立 Python 虛擬環境
python3 -m venv venv

# 啟動虛擬環境
source venv/bin/activate

# 更新 pip
pip install --upgrade pip

# 安裝專案依賴
pip install -r mybot/requirements.txt

# 安裝 Gunicorn（WSGI 伺服器）
pip install gunicorn

# 驗證安裝
pip list | grep flask
pip list | grep gunicorn
```

---

### 步驟 3：設定環境變數 (.env)

```bash
# 建立 .env 檔案
cd /home/ruru1211-chatbot/htdocs/chatbot.ruru1211.xyz/chatbot
nano .env
```

填入以下內容：

```env
# LINE Bot 憑證（從 LINE Developers Console 取得）
LINE_CHANNEL_ACCESS_TOKEN=你的_Channel_Access_Token
LINE_CHANNEL_SECRET=你的_Channel_Secret

# 資料庫設定（CloudPanel）
DB_HOST=127.0.0.1
DB_PORT=3306
DB_USER=lbblacktech-laravel
DB_PASSWORD=你的資料庫密碼
DB_NAME=lbblacktech-laravel

# 應用設定
PORT=8090
PET_ID=1
OLLAMA_MODEL=qwen:7b

# Flask 環境
FLASK_ENV=production
FLASK_DEBUG=0
```

設定檔案權限：
```bash
chmod 600 .env
```

**取得資料庫密碼**：
- 登入 CloudPanel
- Sites → chatbot.ruru1211.xyz → Databases
- 查看或重設 `lbblacktech-laravel` 使用者密碼

---

### 步驟 4：測試應用程式

```bash
# 確認在專案目錄
cd /home/ruru1211-chatbot/htdocs/chatbot.ruru1211.xyz/chatbot

# 啟動虛擬環境
source venv/bin/activate

# 前台測試（按 Ctrl+C 停止）
gunicorn --bind 127.0.0.1:8090 mybot.app:app
```

**在另一個終端測試**：
```bash
# 測試首頁
curl http://127.0.0.1:8090/

# 測試健康檢查
curl http://127.0.0.1:8090/healthz
```

如果測試成功，按 `Ctrl+C` 停止，繼續下一步。

---

### 步驟 5：設定 Systemd Service（開機自動啟動）

#### 方法 A：使用腳本（推薦）

```bash
cd /home/ruru1211-chatbot/htdocs/chatbot.ruru1211.xyz/chatbot
sudo bash scripts/setup_systemd.sh
```

#### 方法 B：手動建立

```bash
sudo nano /etc/systemd/system/line-bot.service
```

貼上以下內容：

```ini
[Unit]
Description=LINE Bot Service
After=network.target mysql.service

[Service]
Type=notify
User=ruru1211-chatbot
Group=ruru1211-chatbot
WorkingDirectory=/home/ruru1211-chatbot/htdocs/chatbot.ruru1211.xyz/chatbot
Environment="PATH=/home/ruru1211-chatbot/htdocs/chatbot.ruru1211.xyz/chatbot/venv/bin:/usr/bin"
EnvironmentFile=/home/ruru1211-chatbot/htdocs/chatbot.ruru1211.xyz/chatbot/.env

ExecStart=/home/ruru1211-chatbot/htdocs/chatbot.ruru1211.xyz/chatbot/venv/bin/gunicorn \
  --bind 127.0.0.1:8090 \
  --workers 4 \
  --threads 2 \
  --timeout 120 \
  --access-logfile /home/ruru1211-chatbot/logs/access.log \
  --error-logfile /home/ruru1211-chatbot/logs/error.log \
  --log-level info \
  mybot.app:app

Restart=always
RestartSec=10

[Install]
WantedBy=multi-user.target
```

**啟動服務**：

```bash
# 建立日誌目錄
mkdir -p /home/ruru1211-chatbot/logs

# 重新載入 systemd
sudo systemctl daemon-reload

# 啟用服務（開機自動啟動）
sudo systemctl enable line-bot.service

# 啟動服務
sudo systemctl start line-bot.service

# 檢查狀態
sudo systemctl status line-bot.service
```

---

### 步驟 6：設定 Nginx 反向代理

```bash
sudo nano /home/ruru1211-chatbot/htdocs/chatbot.ruru1211.xyz/nginx/line-bot.conf
```

貼上以下內容：

```nginx
pagespeed off;

location /line {
    add_header Cache-Control "no-cache, no-store, must-revalidate";
    proxy_pass http://127.0.0.1:8090;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_set_header X-Line-Signature $http_x_line_signature;
    proxy_connect_timeout 120s;
    proxy_send_timeout 120s;
    proxy_read_timeout 120s;
    proxy_buffering off;
}

location = /line/webhook {
    add_header Cache-Control "no-cache, no-store, must-revalidate";
    rewrite ^/line/webhook$ /webhook break;
    proxy_pass http://127.0.0.1:8090;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_set_header X-Line-Signature $http_x_line_signature;
    proxy_connect_timeout 120s;
    proxy_send_timeout 120s;
    proxy_read_timeout 120s;
    proxy_buffering off;
}

location = /line/healthz {
    rewrite ^/line/healthz$ /healthz break;
    proxy_pass http://127.0.0.1:8090;
    proxy_set_header Host $host;
    access_log off;
}
```

**重載 Nginx**：

```bash
# 測試配置
sudo nginx -t

# 重載 Nginx
sudo systemctl reload nginx
```

---

### 步驟 7：設定 LINE Webhook

1. 登入 [LINE Developers Console](https://developers.line.biz/console/)
2. 選擇你的 Channel
3. 進入 **Messaging API** 頁籤
4. 設定 **Webhook URL**：
   ```
   https://chatbot.ruru1211.xyz/line/webhook
   ```
5. 點擊 **Verify** 測試（應顯示 Success）
6. 啟用 **Use webhook**
7. 關閉 **Auto-reply messages**

---

### 步驟 8：測試完整功能

```bash
# 1. 檢查服務狀態
sudo systemctl status line-bot.service

# 2. 測試本地健康檢查
curl http://127.0.0.1:8090/healthz

# 3. 測試遠端健康檢查
curl https://chatbot.ruru1211.xyz/line/healthz

# 4. 查看日誌
sudo journalctl -u line-bot.service -f

# 5. LINE 對話測試
# 用手機 LINE 加入 Bot 為好友，發送訊息測試
```

---

## 🔄 日常更新流程

### 方法 1：使用自動部署腳本（推薦）

```bash
# SSH 到伺服器
ssh ruru1211-chatbot@chatbot.ruru1211.xyz

# 執行一行指令完成更新
cd /home/ruru1211-chatbot/htdocs/chatbot.ruru1211.xyz/chatbot && bash scripts/deploy_to_server.sh
```

**這個腳本會自動**：
- ✅ 備份 .env 檔案
- ✅ 從 Git 拉取最新程式碼
- ✅ 更新依賴套件
- ✅ 重啟服務
- ✅ 測試健康檢查

### 方法 2：手動更新

```bash
cd /home/ruru1211-chatbot/htdocs/chatbot.ruru1211.xyz/chatbot
git pull origin main
source venv/bin/activate
pip install -r mybot/requirements.txt
sudo systemctl restart line-bot.service
sudo systemctl status line-bot.service
```

---

## 📝 常用指令

```bash
# 服務管理
sudo systemctl start line-bot.service      # 啟動
sudo systemctl stop line-bot.service       # 停止
sudo systemctl restart line-bot.service    # 重啟
sudo systemctl status line-bot.service     # 狀態

# 查看日誌
sudo journalctl -u line-bot.service -f              # 即時日誌
sudo journalctl -u line-bot.service -n 100         # 最近 100 行
tail -f /home/ruru1211-chatbot/logs/error.log      # 錯誤日誌

# 測試
curl http://127.0.0.1:8090/healthz                  # 本地測試
curl https://chatbot.ruru1211.xyz/line/healthz     # 遠端測試

# 進入專案目錄
cd /home/ruru1211-chatbot/htdocs/chatbot.ruru1211.xyz/chatbot
```

---

## ❓ 常見問題

### 1. 服務無法啟動

```bash
# 查看錯誤
sudo journalctl -u line-bot.service -n 50

# 手動測試
cd /home/ruru1211-chatbot/htdocs/chatbot.ruru1211.xyz/chatbot
source venv/bin/activate
gunicorn --bind 127.0.0.1:8090 mybot.app:app
```

### 2. Webhook 驗證失敗

- 檢查 `LINE_CHANNEL_SECRET` 是否正確
- 確認 Nginx 有轉發 `X-Line-Signature` header
- 查看錯誤日誌：`grep "InvalidSignature" /home/ruru1211-chatbot/logs/error.log`

### 3. 資料庫連線失敗

```bash
# 測試資料庫
mysql -h 127.0.0.1 -u lbblacktech-laravel -p lbblacktech-laravel

# 檢查 .env
cat /home/ruru1211-chatbot/htdocs/chatbot.ruru1211.xyz/chatbot/.env | grep DB_
```

### 4. Port 8090 被佔用

```bash
sudo lsof -i :8090
sudo kill <PID>
sudo systemctl restart line-bot.service
```

---

## ✅ 部署檢查清單

- [ ] Git clone 到正確位置（chatbot 子資料夾）
- [ ] 虛擬環境已建立並安裝依賴
- [ ] `.env` 檔案已設定（LINE 憑證 + 資料庫密碼）
- [ ] 測試啟動成功（Gunicorn 前台測試）
- [ ] Systemd service 已設定並運行
- [ ] Nginx 反向代理已設定並測試
- [ ] LINE Webhook 驗證成功
- [ ] 本地健康檢查通過：`curl http://127.0.0.1:8090/healthz`
- [ ] 遠端健康檢查通過：`curl https://chatbot.ruru1211.xyz/line/healthz`
- [ ] LINE 對話測試成功

---

## 🎉 完成！

你的 LINE Bot 已經成功部署在：
- **專案路徑**: `/home/ruru1211-chatbot/htdocs/chatbot.ruru1211.xyz/chatbot`
- **網址**: https://chatbot.ruru1211.xyz
- **Webhook**: https://chatbot.ruru1211.xyz/line/webhook

如有問題，請查看日誌：
```bash
sudo journalctl -u line-bot.service -f
```

