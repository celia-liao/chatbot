# å®Œæ•´éƒ¨ç½²æµç¨‹ï¼ˆchatbot å­è³‡æ–™å¤¾ç‰ˆæœ¬ï¼‰

## ğŸ“‚ ç›®éŒ„çµæ§‹

```
/home/ruru1211-chatbot/htdocs/
â””â”€â”€ chatbot.ruru1211.xyz/          â† CloudPanel Root Directory
    â””â”€â”€ chatbot/                    â† Git repository (å°ˆæ¡ˆå¯¦éš›ä½ç½®)
        â”œâ”€â”€ mybot/                  â† Flask æ‡‰ç”¨
        â”‚   â”œâ”€â”€ __init__.py
        â”‚   â”œâ”€â”€ app.py
        â”‚   â”œâ”€â”€ chatbot_ollama.py
        â”‚   â”œâ”€â”€ config.py
        â”‚   â”œâ”€â”€ db_utils.py
        â”‚   â”œâ”€â”€ personalities.py
        â”‚   â””â”€â”€ requirements.txt
        â”œâ”€â”€ scripts/                â† éƒ¨ç½²è…³æœ¬
        â”‚   â”œâ”€â”€ start_gunicorn.sh
        â”‚   â”œâ”€â”€ setup_systemd.sh
        â”‚   â””â”€â”€ deploy_to_server.sh
        â”œâ”€â”€ docs/                   â† æ–‡æª”èˆ‡é…ç½®ç¯„ä¾‹
        â”‚   â”œâ”€â”€ env_template.txt
        â”‚   â””â”€â”€ nginx_config.conf
        â”œâ”€â”€ venv/                   â† Python è™›æ“¬ç’°å¢ƒ
        â”œâ”€â”€ .env                    â† ç’°å¢ƒè®Šæ•¸ï¼ˆéœ€å»ºç«‹ï¼‰
        â””â”€â”€ .git/                   â† Git repository
```

---

## ğŸš€ å®Œæ•´éƒ¨ç½²æ­¥é©Ÿ

### æ­¥é©Ÿ 1ï¼šGit Clone å°ˆæ¡ˆ

```bash
# SSH åˆ°ä¼ºæœå™¨
ssh ruru1211-chatbot@chatbot.ruru1211.xyz

# é€²å…¥ CloudPanel Root Directory
cd /home/ruru1211-chatbot/htdocs/chatbot.ruru1211.xyz

# Clone repositoryï¼ˆå‡è¨­ä½ çš„ GitHub ç”¨æˆ¶åæ˜¯ your-usernameï¼‰
git clone https://github.com/your-username/chatbot.git

# é€²å…¥å°ˆæ¡ˆç›®éŒ„
cd chatbot

# ç¢ºèªè·¯å¾‘
pwd
# æ‡‰è©²é¡¯ç¤ºï¼š/home/ruru1211-chatbot/htdocs/chatbot.ruru1211.xyz/chatbot
```

---

### æ­¥é©Ÿ 2ï¼šå»ºç«‹è™›æ“¬ç’°å¢ƒä¸¦å®‰è£ä¾è³´

```bash
# ç¢ºèªåœ¨ chatbot ç›®éŒ„
cd /home/ruru1211-chatbot/htdocs/chatbot.ruru1211.xyz/chatbot

# å»ºç«‹ Python è™›æ“¬ç’°å¢ƒ
python3 -m venv venv

# å•Ÿå‹•è™›æ“¬ç’°å¢ƒ
source venv/bin/activate

# æ›´æ–° pip
pip install --upgrade pip

# å®‰è£å°ˆæ¡ˆä¾è³´
pip install -r mybot/requirements.txt

# å®‰è£ Gunicornï¼ˆWSGI ä¼ºæœå™¨ï¼‰
pip install gunicorn

# é©—è­‰å®‰è£
pip list | grep flask
pip list | grep gunicorn
```

---

### æ­¥é©Ÿ 3ï¼šè¨­å®šç’°å¢ƒè®Šæ•¸ (.env)

```bash
# å»ºç«‹ .env æª”æ¡ˆ
cd /home/ruru1211-chatbot/htdocs/chatbot.ruru1211.xyz/chatbot
nano .env
```

å¡«å…¥ä»¥ä¸‹å…§å®¹ï¼š

```env
# LINE Bot æ†‘è­‰ï¼ˆå¾ LINE Developers Console å–å¾—ï¼‰
LINE_CHANNEL_ACCESS_TOKEN=ä½ çš„_Channel_Access_Token
LINE_CHANNEL_SECRET=ä½ çš„_Channel_Secret

# è³‡æ–™åº«è¨­å®šï¼ˆCloudPanelï¼‰
DB_HOST=127.0.0.1
DB_PORT=3306
DB_USER=lbblacktech-laravel
DB_PASSWORD=ä½ çš„è³‡æ–™åº«å¯†ç¢¼
DB_NAME=lbblacktech-laravel

# æ‡‰ç”¨è¨­å®š
PORT=8090
PET_ID=1
OLLAMA_MODEL=qwen:7b

# Flask ç’°å¢ƒ
FLASK_ENV=production
FLASK_DEBUG=0
```

è¨­å®šæª”æ¡ˆæ¬Šé™ï¼š
```bash
chmod 600 .env
```

**å–å¾—è³‡æ–™åº«å¯†ç¢¼**ï¼š
- ç™»å…¥ CloudPanel
- Sites â†’ chatbot.ruru1211.xyz â†’ Databases
- æŸ¥çœ‹æˆ–é‡è¨­ `lbblacktech-laravel` ä½¿ç”¨è€…å¯†ç¢¼

---

### æ­¥é©Ÿ 4ï¼šæ¸¬è©¦æ‡‰ç”¨ç¨‹å¼

```bash
# ç¢ºèªåœ¨å°ˆæ¡ˆç›®éŒ„
cd /home/ruru1211-chatbot/htdocs/chatbot.ruru1211.xyz/chatbot

# å•Ÿå‹•è™›æ“¬ç’°å¢ƒ
source venv/bin/activate

# å‰å°æ¸¬è©¦ï¼ˆæŒ‰ Ctrl+C åœæ­¢ï¼‰
gunicorn --bind 127.0.0.1:8090 mybot.app:app
```

**åœ¨å¦ä¸€å€‹çµ‚ç«¯æ¸¬è©¦**ï¼š
```bash
# æ¸¬è©¦é¦–é 
curl http://127.0.0.1:8090/

# æ¸¬è©¦å¥åº·æª¢æŸ¥
curl http://127.0.0.1:8090/healthz
```

å¦‚æœæ¸¬è©¦æˆåŠŸï¼ŒæŒ‰ `Ctrl+C` åœæ­¢ï¼Œç¹¼çºŒä¸‹ä¸€æ­¥ã€‚

---

### æ­¥é©Ÿ 5ï¼šè¨­å®š Systemd Serviceï¼ˆé–‹æ©Ÿè‡ªå‹•å•Ÿå‹•ï¼‰

#### æ–¹æ³• Aï¼šä½¿ç”¨è…³æœ¬ï¼ˆæ¨è–¦ï¼‰

```bash
cd /home/ruru1211-chatbot/htdocs/chatbot.ruru1211.xyz/chatbot
sudo bash scripts/setup_systemd.sh
```

#### æ–¹æ³• Bï¼šæ‰‹å‹•å»ºç«‹

```bash
sudo nano /etc/systemd/system/line-bot.service
```

è²¼ä¸Šä»¥ä¸‹å…§å®¹ï¼š

```ini
[Unit]
Description=LINE Bot Service
After=network.target mysql.service

[Service]
Type=notify
User=ruru1211-chatbot
Group=ruru1211-chatbot
WorkingDirectory=/home/ruru1211-chatbot/htdocs/chatbot.ruru1211.xyz/chatbot
Environment="PATH=/home/ruru1211-chatbot/htdocs/chatbot.ruru1211.xyz/chatbot/venv/bin:/usr/bin"
EnvironmentFile=/home/ruru1211-chatbot/htdocs/chatbot.ruru1211.xyz/chatbot/.env

ExecStart=/home/ruru1211-chatbot/htdocs/chatbot.ruru1211.xyz/chatbot/venv/bin/gunicorn \
  --bind 127.0.0.1:8090 \
  --workers 4 \
  --threads 2 \
  --timeout 120 \
  --access-logfile /home/ruru1211-chatbot/logs/access.log \
  --error-logfile /home/ruru1211-chatbot/logs/error.log \
  --log-level info \
  mybot.app:app

Restart=always
RestartSec=10

[Install]
WantedBy=multi-user.target
```

**å•Ÿå‹•æœå‹™**ï¼š

```bash
# å»ºç«‹æ—¥èªŒç›®éŒ„
mkdir -p /home/ruru1211-chatbot/logs

# é‡æ–°è¼‰å…¥ systemd
sudo systemctl daemon-reload

# å•Ÿç”¨æœå‹™ï¼ˆé–‹æ©Ÿè‡ªå‹•å•Ÿå‹•ï¼‰
sudo systemctl enable line-bot.service

# å•Ÿå‹•æœå‹™
sudo systemctl start line-bot.service

# æª¢æŸ¥ç‹€æ…‹
sudo systemctl status line-bot.service
```

---

### æ­¥é©Ÿ 6ï¼šè¨­å®š Nginx åå‘ä»£ç†

```bash
sudo nano /home/ruru1211-chatbot/htdocs/chatbot.ruru1211.xyz/nginx/line-bot.conf
```

è²¼ä¸Šä»¥ä¸‹å…§å®¹ï¼š

```nginx
pagespeed off;

location /line {
    add_header Cache-Control "no-cache, no-store, must-revalidate";
    proxy_pass http://127.0.0.1:8090;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_set_header X-Line-Signature $http_x_line_signature;
    proxy_connect_timeout 120s;
    proxy_send_timeout 120s;
    proxy_read_timeout 120s;
    proxy_buffering off;
}

location = /line/webhook {
    add_header Cache-Control "no-cache, no-store, must-revalidate";
    rewrite ^/line/webhook$ /webhook break;
    proxy_pass http://127.0.0.1:8090;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_set_header X-Line-Signature $http_x_line_signature;
    proxy_connect_timeout 120s;
    proxy_send_timeout 120s;
    proxy_read_timeout 120s;
    proxy_buffering off;
}

location = /line/healthz {
    rewrite ^/line/healthz$ /healthz break;
    proxy_pass http://127.0.0.1:8090;
    proxy_set_header Host $host;
    access_log off;
}
```

**é‡è¼‰ Nginx**ï¼š

```bash
# æ¸¬è©¦é…ç½®
sudo nginx -t

# é‡è¼‰ Nginx
sudo systemctl reload nginx
```

---

### æ­¥é©Ÿ 7ï¼šè¨­å®š LINE Webhook

1. ç™»å…¥ [LINE Developers Console](https://developers.line.biz/console/)
2. é¸æ“‡ä½ çš„ Channel
3. é€²å…¥ **Messaging API** é ç±¤
4. è¨­å®š **Webhook URL**ï¼š
   ```
   https://chatbot.ruru1211.xyz/line/webhook
   ```
5. é»æ“Š **Verify** æ¸¬è©¦ï¼ˆæ‡‰é¡¯ç¤º Successï¼‰
6. å•Ÿç”¨ **Use webhook**
7. é—œé–‰ **Auto-reply messages**

---

### æ­¥é©Ÿ 8ï¼šæ¸¬è©¦å®Œæ•´åŠŸèƒ½

```bash
# 1. æª¢æŸ¥æœå‹™ç‹€æ…‹
sudo systemctl status line-bot.service

# 2. æ¸¬è©¦æœ¬åœ°å¥åº·æª¢æŸ¥
curl http://127.0.0.1:8090/healthz

# 3. æ¸¬è©¦é ç«¯å¥åº·æª¢æŸ¥
curl https://chatbot.ruru1211.xyz/line/healthz

# 4. æŸ¥çœ‹æ—¥èªŒ
sudo journalctl -u line-bot.service -f

# 5. LINE å°è©±æ¸¬è©¦
# ç”¨æ‰‹æ©Ÿ LINE åŠ å…¥ Bot ç‚ºå¥½å‹ï¼Œç™¼é€è¨Šæ¯æ¸¬è©¦
```

---

## ğŸ”„ æ—¥å¸¸æ›´æ–°æµç¨‹

### æ–¹æ³• 1ï¼šä½¿ç”¨è‡ªå‹•éƒ¨ç½²è…³æœ¬ï¼ˆæ¨è–¦ï¼‰

```bash
# SSH åˆ°ä¼ºæœå™¨
ssh ruru1211-chatbot@chatbot.ruru1211.xyz

# åŸ·è¡Œä¸€è¡ŒæŒ‡ä»¤å®Œæˆæ›´æ–°
cd /home/ruru1211-chatbot/htdocs/chatbot.ruru1211.xyz/chatbot && bash scripts/deploy_to_server.sh
```

**é€™å€‹è…³æœ¬æœƒè‡ªå‹•**ï¼š
- âœ… å‚™ä»½ .env æª”æ¡ˆ
- âœ… å¾ Git æ‹‰å–æœ€æ–°ç¨‹å¼ç¢¼
- âœ… æ›´æ–°ä¾è³´å¥—ä»¶
- âœ… é‡å•Ÿæœå‹™
- âœ… æ¸¬è©¦å¥åº·æª¢æŸ¥

### æ–¹æ³• 2ï¼šæ‰‹å‹•æ›´æ–°

```bash
cd /home/ruru1211-chatbot/htdocs/chatbot.ruru1211.xyz/chatbot
git pull origin main
source venv/bin/activate
pip install -r mybot/requirements.txt
sudo systemctl restart line-bot.service
sudo systemctl status line-bot.service
```

---

## ğŸ“ å¸¸ç”¨æŒ‡ä»¤

```bash
# æœå‹™ç®¡ç†
sudo systemctl start line-bot.service      # å•Ÿå‹•
sudo systemctl stop line-bot.service       # åœæ­¢
sudo systemctl restart line-bot.service    # é‡å•Ÿ
sudo systemctl status line-bot.service     # ç‹€æ…‹

# æŸ¥çœ‹æ—¥èªŒ
sudo journalctl -u line-bot.service -f              # å³æ™‚æ—¥èªŒ
sudo journalctl -u line-bot.service -n 100         # æœ€è¿‘ 100 è¡Œ
tail -f /home/ruru1211-chatbot/logs/error.log      # éŒ¯èª¤æ—¥èªŒ

# æ¸¬è©¦
curl http://127.0.0.1:8090/healthz                  # æœ¬åœ°æ¸¬è©¦
curl https://chatbot.ruru1211.xyz/line/healthz     # é ç«¯æ¸¬è©¦

# é€²å…¥å°ˆæ¡ˆç›®éŒ„
cd /home/ruru1211-chatbot/htdocs/chatbot.ruru1211.xyz/chatbot
```

---

## â“ å¸¸è¦‹å•é¡Œ

### 1. æœå‹™ç„¡æ³•å•Ÿå‹•

```bash
# æŸ¥çœ‹éŒ¯èª¤
sudo journalctl -u line-bot.service -n 50

# æ‰‹å‹•æ¸¬è©¦
cd /home/ruru1211-chatbot/htdocs/chatbot.ruru1211.xyz/chatbot
source venv/bin/activate
gunicorn --bind 127.0.0.1:8090 mybot.app:app
```

### 2. Webhook é©—è­‰å¤±æ•—

- æª¢æŸ¥ `LINE_CHANNEL_SECRET` æ˜¯å¦æ­£ç¢º
- ç¢ºèª Nginx æœ‰è½‰ç™¼ `X-Line-Signature` header
- æŸ¥çœ‹éŒ¯èª¤æ—¥èªŒï¼š`grep "InvalidSignature" /home/ruru1211-chatbot/logs/error.log`

### 3. è³‡æ–™åº«é€£ç·šå¤±æ•—

```bash
# æ¸¬è©¦è³‡æ–™åº«
mysql -h 127.0.0.1 -u lbblacktech-laravel -p lbblacktech-laravel

# æª¢æŸ¥ .env
cat /home/ruru1211-chatbot/htdocs/chatbot.ruru1211.xyz/chatbot/.env | grep DB_
```

### 4. Port 8090 è¢«ä½”ç”¨

```bash
sudo lsof -i :8090
sudo kill <PID>
sudo systemctl restart line-bot.service
```

---

## âœ… éƒ¨ç½²æª¢æŸ¥æ¸…å–®

- [ ] Git clone åˆ°æ­£ç¢ºä½ç½®ï¼ˆchatbot å­è³‡æ–™å¤¾ï¼‰
- [ ] è™›æ“¬ç’°å¢ƒå·²å»ºç«‹ä¸¦å®‰è£ä¾è³´
- [ ] `.env` æª”æ¡ˆå·²è¨­å®šï¼ˆLINE æ†‘è­‰ + è³‡æ–™åº«å¯†ç¢¼ï¼‰
- [ ] æ¸¬è©¦å•Ÿå‹•æˆåŠŸï¼ˆGunicorn å‰å°æ¸¬è©¦ï¼‰
- [ ] Systemd service å·²è¨­å®šä¸¦é‹è¡Œ
- [ ] Nginx åå‘ä»£ç†å·²è¨­å®šä¸¦æ¸¬è©¦
- [ ] LINE Webhook é©—è­‰æˆåŠŸ
- [ ] æœ¬åœ°å¥åº·æª¢æŸ¥é€šéï¼š`curl http://127.0.0.1:8090/healthz`
- [ ] é ç«¯å¥åº·æª¢æŸ¥é€šéï¼š`curl https://chatbot.ruru1211.xyz/line/healthz`
- [ ] LINE å°è©±æ¸¬è©¦æˆåŠŸ

---

## ğŸ‰ å®Œæˆï¼

ä½ çš„ LINE Bot å·²ç¶“æˆåŠŸéƒ¨ç½²åœ¨ï¼š
- **å°ˆæ¡ˆè·¯å¾‘**: `/home/ruru1211-chatbot/htdocs/chatbot.ruru1211.xyz/chatbot`
- **ç¶²å€**: https://chatbot.ruru1211.xyz
- **Webhook**: https://chatbot.ruru1211.xyz/line/webhook

å¦‚æœ‰å•é¡Œï¼Œè«‹æŸ¥çœ‹æ—¥èªŒï¼š
```bash
sudo journalctl -u line-bot.service -f
```

